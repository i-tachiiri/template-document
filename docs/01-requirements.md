## プロジェクト名

## 利用者

## 利用者の課題

## 用語

- **専用共有ドライブ** : サービスアカウントへ権限のある共有ドライブ。ここの配下で各ドライブのアイテムが作成される
- **商品一覧** : 共有ドライブ配下の各フォルダで定義される
- **鑑定情報回答フォーム** : Googleフォーム。回答を顧客リストマスタに出力する。
- **顧客情報** : 生まれた年・月・日・時・分、生まれた場所の国・都道府県・市町村・緯度・経度、タイムゾーン
- **顧客リストマスタ** : スプレッドシートで作成された、顧客リストの名前とIDの一覧。商品ごとに別のスプレッドシートになっている
- **顧客リスト++ : Googleフォームの回答を反映したスプレッドシート。生まれた年・月・日・時・分、生まれた場所の国・都道府県・市町村を含む。ユニークIDはスプレッドシート側で生成する
- **共通ページフォルダ** : Googleドライブの「共通ページ」フォルダ。全レポートに共通するページを格納する
- **共通ページマスタ** : 表紙・ヘッダー・はじめに・本文・おわりに・フッター・その他の並び順を指定する。**共通ページ**のPDF+本文(固定値)に対し、ファイルIDと並び順を紐づける
- **共通ページ** : 表紙・ヘッダー・はじめに・おわりに・フッター・その他全レポートに共通のページを指す。PDFで作成し、所定のフォルダに置く
- **アスペクトマスタ** : 天体星座の並び順・章の見出し
- **チャプター** : 天体星座単位で表されるレポートの章。チャプターの順番はアスペクトマスタで定義される
- **セクション** : 「天体A」と「天体B」の「アスペクト」で表される値。天体Aはチャプターから取得されるので、天体Bとアスペクトをユーザーが選択する
- **鑑定マスタ** : スプレッドシート。天体星座ごとにシートがあり、組み合わせの天体×アスペクトごとに鑑定のテキストが記載されている
- **鑑定テキスト** : チャプターとセクションを元に、鑑定マスタから顧客の鑑定情報を取得し、結合したテキスト
- **レポート本文PDF** : Googleドキュメントで作成したレポート本文。プログラムからテンプレートをコピーし、鑑定テキストを挿入して、レポート本体のPDFを作成する

## 業務手順

- **専用共有ドライブ**のセットアップをする
  - 商品フォルダのテンプレートをコピーする
  - 作業者にアクセス権限を設定する
  -  **共通ページフォルダ**に必要なPDFを格納する
  - **鑑定マスタ**に必要な情報を入力する 
- ログインページへアクセスする
- Googleアカウントでログインする
  - エンドユーザーのOAuth2.0トークン認証
  - スプレッドシート・Googleドライブの読み取り・書き込み権限をスコープに加える
  - **商品一覧**のフォルダのうち、アクセス権限のあるものについて、フォルダ名・レポート選択画面へのリンクが表示される
  - アクセス権限のあるフォルダがなければ、全フォルダを表示してフォルダへのURLを表示。リンク先でアクセス権限リクエストを行うよう案内
  - 顧客選択画面を開く
- 顧客選択画面にアクセスする
  - ログインしたアクセストークンを利用し、顧客リストから顧客一覧を取得・表示する
    - アクセス権限がなければ、スプレッドシートへのURLを表示。リンク先でアクセス権限リクエストを行うよう案内
  - 顧客を選択して顧客一覧ページへ進む
  - **顧客情報**のフォームを入力する
    - 生まれた年・月・日・時・分、生まれた場所の国・都道府県・市町村はスプレッドシートから取得して入力する
    - 生まれた年・月・日・時・分はバリデーションを行う
    - 緯度・経度はユーザーが入力する。数値である事をバリデーションする
    - タイムゾーンは初期値を東京にして、プルダウンで選択可能にする
    - アスペクト選択画面へ進む
- アスペクト選択画面にアクセスする
  - アスペクトマスタを参照し**チャプター**を表示する
    - アクセス権限がなければ、スプレッドシートへのURLを表示。リンク先でアクセス権限リクエストを行うよう案内
  - チャプターごとに**セクション**を追加できるようにする
    - デフォルトでは天体Aの固定値と、天体B・アスペクトのプルダウンがある
    - プルダウンを選択して「追加」を押すと次のプルダウンが出てくる
    - 未追加のプルダウンは、未入力として扱う
      - 将来的にSwissEphNetからの自動計算による拡張を想定。Blazor WASMで実行できない場合は実装しない
- プレビュー画面を開く
  - 入力されたチャプター・セクションの情報を元に**鑑定テキスト**を作成
  - **鑑定テキスト**からプレビューのページを作成・表示する
    - チャプターをH2, セクションをH3, 画像は中央表示にする
    - サイドバーで目次を表示し、各チャプター・セクションへ飛べるようにする
    - 鑑定マスタにテキストのない項目があった場合、ページトップに警告を表示＆次へ進めないようにする
  - PDF作成ページへ進む
- PDF作成ページへ進む
  - **鑑定テキスト**から**レポート本文PDF**を作成
    - PDFのエクスポートは
  - **共通ページマスタ**を参照し、設定されている順にレポートのPDFを結合する
